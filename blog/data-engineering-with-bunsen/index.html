<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>
  
     Scalable Data Science with FHIR | 
    Engineering Health
  
</title><meta name="description" content="a blog by engineers, for engineers"><meta name="author" content="Ryan Brush">

<link rel="icon" href="/favicon.png">


    
        
            <link rel="stylesheet" href="/dist/main.2b1315bd4c5d4f5eb804.min.css">
        
    




<link rel="canonical" href="https://engineering.cerner.com/blog/data-engineering-with-bunsen/"><script src="/js/jquery-3.5.1.min.js"></script><meta property="og:title" content="Scalable Data Science with FHIR" />
<meta property="og:description" content="The FHIR standard started as a better way to exchange healthcare data, but it also provides a solid basis for deep analytics and Machine Learning at scale. This post looks at an example from the recent FHIR DevDays conference that does just that. You can also run the interactive FHIR data engineering tutorial used in the conference yourself.
Our first step is to bring FHIR data into a data lake &ndash; a computational environment where our analysis can easily and efficiently work through petabytes of data." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://engineering.cerner.com/blog/data-engineering-with-bunsen/" /><meta property="og:image" content="https://engineering.cerner.com/images/alan-grace.png"/><meta property="article:section" content="post" />
<meta property="article:published_time" content="2018-07-02T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-07-02T00:00:00+00:00" /><meta property="og:site_name" content="Cerner Engineering" />

<meta itemprop="name" content="Scalable Data Science with FHIR">
<meta itemprop="description" content="The FHIR standard started as a better way to exchange healthcare data, but it also provides a solid basis for deep analytics and Machine Learning at scale. This post looks at an example from the recent FHIR DevDays conference that does just that. You can also run the interactive FHIR data engineering tutorial used in the conference yourself.
Our first step is to bring FHIR data into a data lake &ndash; a computational environment where our analysis can easily and efficiently work through petabytes of data."><meta itemprop="datePublished" content="2018-07-02T00:00:00+00:00" />
<meta itemprop="dateModified" content="2018-07-02T00:00:00+00:00" />
<meta itemprop="wordCount" content="1115"><meta itemprop="image" content="https://engineering.cerner.com/images/alan-grace.png"/>
<meta itemprop="keywords" content="engineering,spark,FHIR,bunsen," /><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://engineering.cerner.com/images/alan-grace.png"/>

<meta name="twitter:title" content="Scalable Data Science with FHIR"/>
<meta name="twitter:description" content="The FHIR standard started as a better way to exchange healthcare data, but it also provides a solid basis for deep analytics and Machine Learning at scale. This post looks at an example from the recent FHIR DevDays conference that does just that. You can also run the interactive FHIR data engineering tutorial used in the conference yourself.
Our first step is to bring FHIR data into a data lake &ndash; a computational environment where our analysis can easily and efficiently work through petabytes of data."/>

</head>
<body>
    
<nav class="navbar navbar-expand-md navbar-light bg-light fixed-top shadow-sm" id="navbar-main-menu">
    <div class="container">
        <a class="navbar-brand" href="/"><img src="/logo.png" style='height: 40px;' /></a>
        <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#main-menu" aria-controls="main-menu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div id="main-menu" class="collapse navbar-collapse" >
            <ul class="nav navbar-nav ml-auto">
                
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/culture/">Culture</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/open-source/">Open Source</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/tech-talks/">Tech Talks</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/careers/">Careers</a></li>
                
            
            </ul>
            
            <div class="form-inline my-2 my-lg-0 searchbox">
    <input id="search-by" type="search" class="form-control mr-sm-2" placeholder="Search" aria-label="Search">
</div>

<script type="text/javascript" src="/js/lunr.min.js"></script>
<script type="text/javascript" src="/js/auto-complete.min.js"></script>
<script type="text/javascript">
    var baseurl =  "https:\/\/engineering.cerner.com";
</script>
<script type="text/javascript" src="/js/search.js"></script>
        </div>
    </div>
</nav>


    
<main class="content-page container pt-7 pb-5">
    
    <div class="row">
        <div class="col">
            <article class="article-content">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="meta text-muted mb-3">
                            <p class="created text-muted text-uppercase font-weight-bold mb-1">July 2, 2018</p>
                            <span class="mr-2"><i class="fas fa-book-open mr-2"></i>1115 words</span>
                            <span><i class="fas fa-clock mr-2"></i>6 mins read</span>
                        </div>

                        <h1>Scalable Data Science with FHIR</h1>

                        <ul class="authors list-inline">
        By: &nbsp;<li class="list-inline-item mr-3">
                    <div class="media author">
                            👤&nbsp;<div class="media-body">
                            <h5 class="name my-0 "><a href="/authors/ryan-brush/" class="small">Ryan Brush</a>
                            </h5>
                        </div>
                    </div>
                </li></ul>
                    </div>
                </div>

                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="content">
                            <p>The <a href="https://www.hl7.org/fhir/overview.html">FHIR standard</a> started as a better way to exchange healthcare data, but it also provides a solid basis for deep analytics and Machine Learning at scale. This post looks at an example from the recent <a href="https://www.fhirdevdays.com/">FHIR DevDays</a> conference that does just that. You can also run the interactive <a href="https://github.com/cerner/bunsen-tutorial">FHIR data engineering tutorial</a> used in the conference yourself.</p>
<p>Our first step is to bring FHIR data into a data lake &ndash; a computational environment where our analysis can easily and efficiently work through petabytes of data. We&rsquo;ll look at some patterns for doing so, with concrete examples using the open source <a href="http://engineering.cerner.com/bunsen">Bunsen</a> and <a href="https://spark.apache.org/">Apache Spark</a> projects.</p>
<h3 id="fhir-structuredefinitions-define-the-schema">FHIR StructureDefinitions Define the Schema</h3>
<p>The schema for every dataset you see here was generated from a <a href="https://www.hl7.org/fhir/stu3/structuredefinition.html">FHIR StructureDefinition</a>. There is a big gap between building a FHIR-based schema by hand and generating it directly from the source. Every field in every query here is fully documented as a <a href="https://www.hl7.org/fhir/stu3/resourcelist.html">FHIR resource</a>, making the FHIR documentation itself the primary reference to our datasets. This means the data is well-defined, curated, and familiar to those who have used FHIR.</p>
<h3 id="data-catalogs-over-filesystems">Data Catalogs over Filesystems</h3>
<p>Organizing data in files and directories is convenient, but it becomes unwieldy when working with a large number of complex datasets. Data catalogs can meet this need &ndash; and to offer a foundation for further data governance. The <a href="https://hive.apache.org/">Apache Hive metastore</a> is the most common way to catalog data in Hadoop-based environments and has native integration with Spark, so we organize data as one FHIR resource per table. Here&rsquo;s an example from the <a href="https://github.com/cerner/bunsen-tutorial/blob/fhirdevdays2018/data_engineering_tutorial.ipynb">tutorial used at FHIR DevDays</a>:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>spark<span style="color:#f92672">.</span>sql(<span style="color:#e6db74">&#39;use tutorial_small&#39;</span>)
</span></span><span style="display:flex;"><span>spark<span style="color:#f92672">.</span>sql(<span style="color:#e6db74">&#39;show tables&#39;</span>)<span style="color:#f92672">.</span>toPandas()
</span></span></code></pre></td></tr></table>
</div>
</div><p>Which prints a table like this:</p>
<table>
<thead>
<tr>
<th style="text-align:left">database</th>
<th style="text-align:left">tableName</th>
<th style="text-align:left">isTemporary</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">tutorial_small</td>
<td style="text-align:left">allergyintolerance</td>
<td style="text-align:left">false</td>
</tr>
<tr>
<td style="text-align:left">tutorial_small</td>
<td style="text-align:left">careplan</td>
<td style="text-align:left">false</td>
</tr>
<tr>
<td style="text-align:left">tutorial_small</td>
<td style="text-align:left">claim</td>
<td style="text-align:left">false</td>
</tr>
<tr>
<td style="text-align:left">tutorial_small</td>
<td style="text-align:left">condition</td>
<td style="text-align:left">false</td>
</tr>
</tbody>
</table>
<p>&hellip;and so on. This makes it trivial to use intuitive database metaphors like <code>use tutorial_small</code> and <code>select * from condition</code>.</p>
<h3 id="first-class-valueset-support">First-class ValueSet Support</h3>
<p><a href="https://www.hl7.org/fhir/stu3/valueset.html">FHIR ValueSets</a> &ndash; collections of code values for a specific purpose &ndash; are essential to querying or working with FHIR data. Therefore they should be a first-class construct in our healthcare data lake. Here&rsquo;s a look at using some FHIR valuesets in our queries as supported by <a href="https://engineering.cerner.com/bunsen/0.4.0/">Bunsen</a>.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> bunsen.stu3.valuesets <span style="color:#f92672">import</span> push_valuesets, valueset, isa_loinc, isa_snomed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>push_valuesets(spark,
</span></span><span style="display:flex;"><span>               {<span style="color:#e6db74">&#39;ldl&#39;</span>          : isa_loinc(<span style="color:#e6db74">&#39;18262-6&#39;</span>), <span style="color:#75715e"># Loads LOINC descendants</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;hdl&#39;</span>          : isa_loinc(<span style="color:#e6db74">&#39;2085-9&#39;</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;hypertension&#39;</span> : isa_snomed(<span style="color:#e6db74">&#39;38341003&#39;</span>), <span style="color:#75715e"># Loads SNOMED descendants</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Loaded from a FHIR ValueSet resource</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;chd&#39;</span>          : valueset(<span style="color:#e6db74">&#39;http://engineering.cerner.com/bunsen/example/chd&#39;</span>, <span style="color:#e6db74">&#39;201806001&#39;</span>)});
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we can use these valuesets in our SQL queries via the <em>in_valueset</em> user-defined function:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>spark<span style="color:#f92672">.</span>sql(<span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">select subject.reference,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       code.coding[0].system system,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       code.coding[0].code code,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       onsetDateTime
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">from condition
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">where in_valueset(code, &#39;chd&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>)<span style="color:#f92672">.</span>limit(<span style="color:#ae81ff">10</span>)<span style="color:#f92672">.</span>toPandas()
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th style="text-align:left">reference</th>
<th style="text-align:left">system</th>
<th style="text-align:left">code</th>
<th style="text-align:left">onsetDateTime</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">urn:uuid:f88c&hellip;</td>
<td style="text-align:left"><a href="http://snomed.info/sct">http://snomed.info/sct</a></td>
<td style="text-align:left">53741008</td>
<td style="text-align:left">2014-09-14T07:45:47</td>
</tr>
<tr>
<td style="text-align:left">urn:uuid:d9ac&hellip;</td>
<td style="text-align:left"><a href="http://snomed.info/sct">http://snomed.info/sct</a></td>
<td style="text-align:left">53741008</td>
<td style="text-align:left">2017-05-22T06:56:19</td>
</tr>
<tr>
<td style="text-align:left">urn:uuid:7460&hellip;</td>
<td style="text-align:left"><a href="http://snomed.info/sct">http://snomed.info/sct</a></td>
<td style="text-align:left">53741008</td>
<td style="text-align:left">1974-08-06T06:50:32</td>
</tr>
<tr>
<td style="text-align:left">urn:uuid:5a28&hellip;</td>
<td style="text-align:left"><a href="http://snomed.info/sct">http://snomed.info/sct</a></td>
<td style="text-align:left">53741008</td>
<td style="text-align:left">2015-08-28T01:17:20</td>
</tr>
</tbody>
</table>
<p>It&rsquo;s worth looking at what&rsquo;s going on here: in a few lines of SQL, we are going from the rich (but somewhat complicated) FHIR Condition data model to a simple table of onset times of Coronary Heart Disease conditions.</p>
<h3 id="fhir-data-in-columnar-storage">FHIR Data in Columnar Storage</h3>
<p>Users see a clear catalog of FHIR datasets, but something important is happening behind the scenes. Most data stores or serialization encodings like JSON keep data in a row-wise format. This means all columns from a given record are physically adjacent on disk, like this:</p>
<div align="center">
    <figure class="figure">
        <a href="row-wise.png" class="d-block" data-toggle="lightbox" data-gallery="post-gallery">
            <img src="row-wise.png"class="figure-img img-fluid"
            /> 
        </a>
    </figure>
</div>
<p>This is a good fit for many workloads, but often not for analysis at scale. For instance, we may want to query the &ldquo;code&rdquo; column of several billion observation rows, and retrieve only those in a certain valueset. This is more efficient if columns are grouped together, like this:</p>
<div align="center">
    <figure class="figure">
        <a href="columnar.png" class="d-block" data-toggle="lightbox" data-gallery="post-gallery">
            <img src="columnar.png"class="figure-img img-fluid"
            /> 
        </a>
    </figure>
</div>
<p>This is completely transparent to the user; she simply sees FHIR data from the specification.</p>
<p>So while users see the FHIR data model, it is encoded in a columnar file like Parquet. In such files, all of these &ldquo;code&rdquo; columns next to one another, allowing the queries to do tight scans over columns of interest without expensive seeking past unneeded data.</p>
<h3 id="creating-for-purpose-views">Creating For-Purpose Views</h3>
<p>These are the building blocks that simplify otherwise complex analysis. For instance, if we want to identify people with diabetes-related risks, we can create a collection of simple views of the underlying data customized for that purpose. You can see the full example in the <a href="https://github.com/cerner/bunsen-tutorial/blob/fhirdevdays2018/data_engineering_tutorial.ipynb">Bunsen data engineering tutorial</a>, but we&rsquo;ll start with a dataframe of people with diabetes-related conditions as defined by a provided ValueSet:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>diabetes_conditions <span style="color:#f92672">=</span> spark<span style="color:#f92672">.</span>sql(<span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">select id condition_id,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       subject.reference person_ref,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       coding.system,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       coding.code,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       coding.display
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">from condition
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     lateral view explode(code.coding) nested as coding
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">where in_valueset(code, &#39;diabetes_risks&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th style="text-align:left">condition_id</th>
<th style="text-align:left">person_ref</th>
<th style="text-align:left">system</th>
<th style="text-align:left">code</th>
<th style="text-align:left">display</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">urn:uuid:9c72&hellip;</td>
<td style="text-align:left">urn:uuid:5a28&hellip;</td>
<td style="text-align:left"><a href="http://snomed.info/sct">http://snomed.info/sct</a></td>
<td style="text-align:left">44054006</td>
<td style="text-align:left">Diabetes</td>
</tr>
<tr>
<td style="text-align:left">urn:uuid:56d5&hellip;</td>
<td style="text-align:left">urn:uuid:214f&hellip;</td>
<td style="text-align:left"><a href="http://snomed.info/sct">http://snomed.info/sct</a></td>
<td style="text-align:left">15777000</td>
<td style="text-align:left">Prediabetes</td>
</tr>
<tr>
<td style="text-align:left">urn:uuid:69de&hellip;</td>
<td style="text-align:left">urn:uuid:7f4d&hellip;</td>
<td style="text-align:left"><a href="http://snomed.info/sct">http://snomed.info/sct</a></td>
<td style="text-align:left">15777000</td>
<td style="text-align:left">Prediabetes</td>
</tr>
</tbody>
</table>
<p>We can inspect and validate this dataframe, and then move onto the next part of our analysis. Let&rsquo;s say we want to exclude anyone who has had a wellness visit in the last two years from our analysis. We just build a dataframe with them:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>wellness_visits <span style="color:#f92672">=</span> spark<span style="color:#f92672">.</span>sql(<span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">select subject.reference person_ref,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       period.start encounter_start,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       period.end encounter_end
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">from encounter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">where class.code = &#39;WELLNESS&#39; and
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      period.start &gt; &#39;2016&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th style="text-align:left">person_ref</th>
<th style="text-align:left">encounter_start</th>
<th style="text-align:left">encounter_end</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">urn:uuid:f88c&hellip;</td>
<td style="text-align:left">2016-08-21T07:45:47</td>
<td style="text-align:left">2016-08-21T07:45:47</td>
</tr>
<tr>
<td style="text-align:left">urn:uuid:f88c&hellip;</td>
<td style="text-align:left">2017-08-27T07:45:47</td>
<td style="text-align:left">2017-08-27T07:45:47</td>
</tr>
<tr>
<td style="text-align:left">urn:uuid:d9ac&hellip;</td>
<td style="text-align:left">2016-05-16T06:56:19</td>
<td style="text-align:left">2016-05-16T06:56:19</td>
</tr>
</tbody>
</table>
<p>Now that we&rsquo;ve loaded and analyzed our dataframes, we can simply exclude those with wellness visits by doing an anti join between them:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>diabetes_without_wellness <span style="color:#f92672">=</span> diabetes_conditions<span style="color:#f92672">.</span>join(wellness_visits,
</span></span><span style="display:flex;"><span>                                                     [<span style="color:#e6db74">&#39;person_ref&#39;</span>],
</span></span><span style="display:flex;"><span>                                                     <span style="color:#e6db74">&#39;left_anti&#39;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>The result is a simple table containing the cohort we&rsquo;re looking for! Check out the complete <a href="https://github.com/cerner/bunsen-tutorial/blob/fhirdevdays2018/data_engineering_tutorial.ipynb">tutorial notebook</a> for the full story.</p>
<h3 id="reproducible-results-from-immutable-data">Reproducible Results from Immutable Data</h3>
<p>Repeatability is an essential property for deep analysis. Re-running the same notebook in the future must load <em>exactly</em> the same data and produce <em>exactly</em> the same results. This gives us the controls needed to build on and iteratively improve previous analysis over time. Fortunately, using immutable data partitions are a common pattern in this type of system. We won&rsquo;t go into depth here, but will touch on a couple good practices:</p>
<ul>
<li>Data is never mutated. Updates coming into our data lake are appended to previous data, and we can reproduce previous results by only working with data that was available at a given processing time.</li>
<li>If necessary, a policy to archive or remove previous views of data from the data catalog is used to manage size.</li>
</ul>
<p>Finally, building on such a FHIR-based data lake enables portability. The predictive model or analysis output is fully captured starting with portable data &ndash; which means it can be more easily deployed into other systems. FHIR has made great progress in exchanging data in online systems, and we see a lot of promise for data science at scale as well.</p>

                        </div><div class="tags my-3"><a class="badge badge-pill badge-light border mr-2" href="/tags/engineering">
                                    <i class="fas fa-tag mr-2"></i>engineering
                                </a><a class="badge badge-pill badge-light border mr-2" href="/tags/spark">
                                    <i class="fas fa-tag mr-2"></i>spark
                                </a><a class="badge badge-pill badge-light border mr-2" href="/tags/fhir">
                                    <i class="fas fa-tag mr-2"></i>FHIR
                                </a><a class="badge badge-pill badge-light border mr-2" href="/tags/bunsen">
                                    <i class="fas fa-tag mr-2"></i>bunsen
                                </a></div><ul class="share nav my-3 justify-content-end">
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://twitter.com/intent/tweet?url=https%3a%2f%2fengineering.cerner.com%2fblog%2fdata-engineering-with-bunsen%2f&text=Scalable%20Data%20Science%20with%20FHIR">
              <i class="fa-fw fab fa-twitter"></i>
          </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fengineering.cerner.com%2fblog%2fdata-engineering-with-bunsen%2f&title=Scalable%20Data%20Science%20with%20FHIR">
                <i class="fa-fw fab fa-linkedin-in"></i>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fengineering.cerner.com%2fblog%2fdata-engineering-with-bunsen%2f&t=Scalable%20Data%20Science%20with%20FHIR">
                <i class="fa-fw fab fa-facebook-f"></i>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://reddit.com/submit?url=https%3a%2f%2fengineering.cerner.com%2fblog%2fdata-engineering-with-bunsen%2f&title=Scalable%20Data%20Science%20with%20FHIR">
                <i class="fa-fw fab fa-reddit-alien"></i>
            </a>
        </li>
    </nav>
                    </div>
                </div>

                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        
                    </div>
                </div></article>
        </div>
    </div>

    <div class="related-content row mt-5 row-cols-1 row-cols-lg-3"><div class="col mb-3">
                <div class="card h-100">
    
    <a href="/blog/announcing-bunsen-fhir-data-with-apache-spark/" class="d-block"><div class="card-body">
            <h4 class="card-title">Announcing Bunsen: FHIR Data with Apache Spark</h4>
            <p class="card-text text-muted text-uppercase">November 27, 2017</p>
            <div class="card-text">
                We’re excited to open source Bunsen, a library to make analyzing FHIR data with Apache Spark simple and scalable. Bunsen encodes FHIR resources directly into Apache Spark’s native data structures. This lets users leverage well-defined FHIR data models directly within Spark SQL.
Here’s a simple query against a table of FHIR observations that produces a table of heart rate values:
spark.sql(&#34;&#34;&#34; select subject.reference person_id, effectiveDateTime date_time, valueQuantity.value value from observations where in_valueset(code, &#39;heart_rate&#39;) &#34;&#34;&#34;).
            </div>
        </div>
    </a>
  </div>
            </div><div class="col mb-3">
                <div class="card h-100">
    
    <a href="/blog/engineers-on-the-road-for-smart-and-fhir/" class="d-block"><img data-src="/blog/engineers-on-the-road-for-smart-and-fhir/smart-and-fhir-01_hu102d0cd74c3c6f70ca2fdeae717cc268_200075_700x350_fill_q75_box_smart1.jpg" class="card-img-top mx-auto d-block" alt="Engineers on the Road for SMART and FHIR (CHC 2016)"><div class="card-body">
            <h4 class="card-title">Engineers on the Road for SMART and FHIR (CHC 2016)</h4>
            <p class="card-text text-muted text-uppercase">March 24, 2017</p>
            <div class="card-text">
                Over the past few years, Cerner has been developing a standards-based platform on top of our Cerner Millennium® EHR. Rather than roll our own API, we’ve been using the HL7® FHIR® standard. For app integration, we’ve been using the SMART® on FHIR specification. If you’re not immediately familiar with those acronyms, you’re definitely not alone.
As we were developing the services, we were also fielding questions from 3rd party developers, answering a lot of questions internally, and trying to keep up with the specifications themselves.
            </div>
        </div>
    </a>
  </div>
            </div><div class="col mb-3">
                <div class="card h-100">
    
    <a href="/blog/cerners-open-source-contributions-for-interoperability-developers/" class="d-block"><div class="card-body">
            <h4 class="card-title">Cerner&#39;s Open Source Contributions for Interoperability Developers</h4>
            <p class="card-text text-muted text-uppercase">June 21, 2018</p>
            <div class="card-text">
                Open source and open standards encourage collaboration around innovation that advances the health care industry through improved interoperability. Developers across health care can come together and use open source code to share information, as well as develop and continually improve apps to support better health outcomes for patients.
At Cerner, developing open platforms that support interoperability standards like SMART® and FHIR® is integral to our mission of transforming health care. In addition to implementing these standards in our platforms, we also participate in organizations like HL7 and the Argonaut Project to help shape and develop these standards.
            </div>
        </div>
    </a>
  </div>
            </div></div>
</main>


    <footer class="footer text-center bg-dark py-6">
    <div class="container">
        <div class="row">
            <div class="col">
                <ul class="list-inline">
                    <li class="list-inline-item"><a href="https://engineering.cerner.com/index.xml" rel="alternate" type="application/rss+xml" class="icons d-block">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a></li><li class="list-inline-item">
                            <a href="https://github.com/cerner" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://www.instagram.com/cernercorporation/" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-instagram fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://www.linkedin.com/company/cerner-corporation" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fengineering.cerner.com%2F&amp;screen_name=CernerEng" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://www.youtube.com/user/cernereng?sub_confirmation=1" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-youtube fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                </ul>

                <p class="text-light">
                    
                        Copyright &copy; 2023
                    
                </p>

                <p class="text-light">
                Made with ❤️ by Cerner engineers.
                </p>
            </div>
        </div>
    </div>
</footer>

    
    
        
            <script src="/dist/main.0f92af9103b4f0550a4b.min.js"></script>
        
    





</body>
</html>
