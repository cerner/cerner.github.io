<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>
  
     Pi Day 2019: Build your own alarm system | 
    Engineering Health
  
</title><meta name="description" content="a blog by engineers, for engineers"><meta name="author" content="Carl Chesser">

<link rel="icon" href="/favicon.png">


    
        
            <link rel="stylesheet" href="/dist/main.2b1315bd4c5d4f5eb804.min.css">
        
    




<link rel="canonical" href="https://engineering.cerner.com/blog/pi-day-2019-build-your-own-alarm-system/"><script src="/js/jquery-3.5.1.min.js"></script><meta property="og:title" content="Pi Day 2019: Build your own alarm system" />
<meta property="og:description" content="At Cerner Engineering, we love to celebrate Pi Day. This day is not only a fun time to enjoy eating pie and reflecting on mathematical properties, but we also share big announcements internally for our developers conference, DevCon.
Drew a crowd to celebrate Pi Day this afternoon with snacks, lightning talks, and our DevCon 2018 theme reveal! #314day #cernerdevcon pic.twitter.com/wyy5eLKHVl
&mdash; Cerner Engineering (@CernerEng) March 14, 2018  For this post, we thought it would be fun to share a simple example of how you can hook your existing monitoring system to a physical alarm system powered by a Raspberry Pi." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://engineering.cerner.com/blog/pi-day-2019-build-your-own-alarm-system/" /><meta property="og:image" content="https://engineering.cerner.com/images/alan-grace.png"/><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-03-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-03-14T00:00:00+00:00" /><meta property="og:site_name" content="Cerner Engineering" />

<meta itemprop="name" content="Pi Day 2019: Build your own alarm system">
<meta itemprop="description" content="At Cerner Engineering, we love to celebrate Pi Day. This day is not only a fun time to enjoy eating pie and reflecting on mathematical properties, but we also share big announcements internally for our developers conference, DevCon.
Drew a crowd to celebrate Pi Day this afternoon with snacks, lightning talks, and our DevCon 2018 theme reveal! #314day #cernerdevcon pic.twitter.com/wyy5eLKHVl
&mdash; Cerner Engineering (@CernerEng) March 14, 2018  For this post, we thought it would be fun to share a simple example of how you can hook your existing monitoring system to a physical alarm system powered by a Raspberry Pi."><meta itemprop="datePublished" content="2019-03-14T00:00:00+00:00" />
<meta itemprop="dateModified" content="2019-03-14T00:00:00+00:00" />
<meta itemprop="wordCount" content="1546"><meta itemprop="image" content="https://engineering.cerner.com/images/alan-grace.png"/>
<meta itemprop="keywords" content="pi,raspberry_pi," /><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://engineering.cerner.com/images/alan-grace.png"/>

<meta name="twitter:title" content="Pi Day 2019: Build your own alarm system"/>
<meta name="twitter:description" content="At Cerner Engineering, we love to celebrate Pi Day. This day is not only a fun time to enjoy eating pie and reflecting on mathematical properties, but we also share big announcements internally for our developers conference, DevCon.
Drew a crowd to celebrate Pi Day this afternoon with snacks, lightning talks, and our DevCon 2018 theme reveal! #314day #cernerdevcon pic.twitter.com/wyy5eLKHVl
&mdash; Cerner Engineering (@CernerEng) March 14, 2018  For this post, we thought it would be fun to share a simple example of how you can hook your existing monitoring system to a physical alarm system powered by a Raspberry Pi."/>

</head>
<body>
    
<nav class="navbar navbar-expand-md navbar-light bg-light fixed-top shadow-sm" id="navbar-main-menu">
    <div class="container">
        <a class="navbar-brand" href="/"><img src="/logo.png" style='height: 40px;' /></a>
        <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#main-menu" aria-controls="main-menu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div id="main-menu" class="collapse navbar-collapse" >
            <ul class="nav navbar-nav ml-auto">
                
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/culture/">Culture</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/open-source/">Open Source</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/tech-talks/">Tech Talks</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/careers/">Careers</a></li>
                
            
            </ul>
            
            <div class="form-inline my-2 my-lg-0 searchbox">
    <input id="search-by" type="search" class="form-control mr-sm-2" placeholder="Search" aria-label="Search">
</div>

<script type="text/javascript" src="/js/lunr.min.js"></script>
<script type="text/javascript" src="/js/auto-complete.min.js"></script>
<script type="text/javascript">
    var baseurl =  "https:\/\/engineering.cerner.com";
</script>
<script type="text/javascript" src="/js/search.js"></script>
        </div>
    </div>
</nav>


    
<main class="content-page container pt-7 pb-5">
    
    <div class="row">
        <div class="col">
            <article class="article-content">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="meta text-muted mb-3">
                            <p class="created text-muted text-uppercase font-weight-bold mb-1">March 14, 2019</p>
                            <span class="mr-2"><i class="fas fa-book-open mr-2"></i>1546 words</span>
                            <span><i class="fas fa-clock mr-2"></i>8 mins read</span>
                        </div>

                        <h1>Pi Day 2019: Build your own alarm system</h1>

                        <ul class="authors list-inline">
        By: &nbsp;<li class="list-inline-item mr-3">
                    <div class="media author"><a href="/authors/carl-chesser/" class="mr-3">
                                    <picture>
                                        <source srcset="/authors/carl-chesser/carl_hubd5913bcf7f5ea3a5cc1974da9663281_38142_48x0_resize_q75_box.jpg 1x, /authors/carl-chesser/carl_hubd5913bcf7f5ea3a5cc1974da9663281_38142_128x0_resize_q100_box.jpg 2x, /authors/carl-chesser/carl_hubd5913bcf7f5ea3a5cc1974da9663281_38142_192x0_resize_q100_box.jpg 3x">
                                        <img src="/authors/carl-chesser/carl_hubd5913bcf7f5ea3a5cc1974da9663281_38142_48x0_resize_q75_box.jpg" class="rounded-circle" alt="Carl Chesser">
                                    </picture>
                                </a><div class="media-body">
                            <h5 class="name my-2 "><a href="/authors/carl-chesser/" class="small">Carl Chesser</a>
                            </h5>
                        </div>
                    </div>
                </li></ul>
                    </div>
                </div>

                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="content">
                            <p>At Cerner Engineering, we love to celebrate <a href="https://en.wikipedia.org/wiki/Pi_Day">Pi Day</a>. This day is not only a fun time to enjoy eating pie and reflecting on mathematical properties, but we also share big announcements internally for our developers conference, <a href="https://engineering.cerner.com/blog/devcon-recap/">DevCon</a>.</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Drew a crowd to celebrate Pi Day this afternoon with snacks, lightning talks, and our DevCon 2018 theme reveal! <a href="https://twitter.com/hashtag/314day?src=hash&amp;ref_src=twsrc%5Etfw">#314day</a> <a href="https://twitter.com/hashtag/cernerdevcon?src=hash&amp;ref_src=twsrc%5Etfw">#cernerdevcon</a> <a href="https://t.co/wyy5eLKHVl">pic.twitter.com/wyy5eLKHVl</a></p>&mdash; Cerner Engineering (@CernerEng) <a href="https://twitter.com/CernerEng/status/974023542504411136?ref_src=twsrc%5Etfw">March 14, 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>For this post, we thought it would be fun to share a simple example of how you can hook your existing monitoring system to a physical alarm system powered by a <a href="https://www.raspberrypi.org/">Raspberry Pi</a>. This alarm will be a red spinning light, the universal symbol of &ldquo;something is going wrong.&rdquo; We will build a program that will integrate with New Relic to determine if there are issues in our environment. If there are any issues, it will trigger the alarm and your monitoring system will come alive!</p>
<h2 id="parts-list">Parts List</h2>
<ul>
<li><a href="https://www.adafruit.com/product/825">Jumper wires</a> - Wires that we will use to trigger the switch from your GPIO pins.</li>
<li><a href="https://www.amazon.com/Rhode-Island-Novelty-Police-Beacon/dp/B0011CZV5A">Alarm light that is AC powered</a> - There are several different types of fun alarm or party lights you could use. The important characteristic that we are seeking is an AC powered light, as we will use this to control its state. Many lights you will find are battery powered, which will not work for this example.</li>
<li><a href="https://www.adafruit.com/product/2935">PowerSwitch Tail or alternative</a> - I have had this setup for quite some time, so I still have a PowerSwitch Tail, but looks like they may not be available by all providers. You can get other alternatives out there, where you can control an AC power switch safely through GPIO interactions.</li>
<li><a href="https://www.raspberrypi.org">Raspberry Pi</a> - I have an older model, but anything with a powered ethernet connection works well (ex. Raspberry Pi 3 Model B+), as we will be making remote HTTPS calls. If this is your first time getting a Raspberry Pi, there are great kits that include your power adapter and SD card (as you will need that too).</li>
<li>RJ45 ethernet cable <em>(optional)</em> - We won‚Äôt leverage WiFi for this example, and simply use a ethernet cable for maintaining a network connection for the Raspberry Pi. You don‚Äôt need this if you already know how you plan to connect your Raspberry Pi to your existing network.</li>
</ul>
<h2 id="the-alarm">The Alarm</h2>
<p>Once you have this setup, we are going to use the Raspberry Pi to control your AC output by communicating to the PowerSwitch Tail through our <a href="https://www.raspberrypi.org/documentation/usage/gpio/">GPIO pins</a>. A <a href="https://golang.org/">Go program</a> will control the logic of flexing the alarm on or off by polling a monitoring system: <a href="https://newrelic.com/">New Relic</a>. New Relic is a real-time monitoring platform that gives you powerful insights about the applications you are operating. One of the features of New Relic, is that you can build alerts about different indicators of your application (ex. high memory utilization of a service). These can be rolled up to an &ldquo;incident&rdquo; concept, when you have <a href="https://docs.newrelic.com/docs/alerts/new-relic-alerts/configuring-alert-policies/specify-when-new-relic-creates-incidents">a violation on an alert condition</a>. For this physical alarm, it made sense to pair it with this concept that we use from New Relic. Therefore, if you build something that would trigger human engagement with your alerts (like an incident), this alarm can generically pick these up, without you having to manage anything else.</p>
<h2 id="the-code">The Code</h2>
<p>Here is the code snippet of what we will implement. It is a Go program, which will interact with the GPIO pins using <a href="https://github.com/stianeikeland/go-rpio">go-rpio</a>. It will essentially run in a loop, and poll New Relic‚Äôs Alert API every minute. To ensure we aren‚Äôt running the alarm in the after-hours, we will also flex when this can trigger (ex. Mon - Friday, 9 - 5 PM).</p>
<p>First, we will build something that can invoke the <a href="https://rpm.newrelic.com/api/explore/alerts_incidents/list">New Relic Alerts API</a>. This will offer a single function (<code>hasOpenIncidents</code>) that will dictate if there are any open incidents when checking with New Relic.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// New Relic Incident API type (just using including two of the fields as an example)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Incident</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Id</span>       <span style="color:#66d9ef">int</span>   <span style="color:#e6db74">`json:&#34;id&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">OpenedAt</span> <span style="color:#66d9ef">int64</span> <span style="color:#e6db74">`json:&#34;opened_at&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// New Relic Incident API response type, which we will assess on having any items in the array for the alarm.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IncidentsResponse</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Incidents</span> []<span style="color:#a6e22e">Incident</span> <span style="color:#e6db74">`json:&#34;incidents&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Documented here: https://rpm.newrelic.com/api/explore/alerts_incidents/list
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">hasOpenIncidents</span>(<span style="color:#a6e22e">apiKey</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">url</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;https://api.newrelic.com/v2/alerts_incidents.json?only_open=true&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">spaceClient</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Client</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Timeout</span>: <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">15</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewRequest</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">MethodGet</span>, <span style="color:#a6e22e">url</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;X-Api-Key&#34;</span>, <span style="color:#a6e22e">apiKey</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">getErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">spaceClient</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">req</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If there is a failure to calling New Relic (ex. timeout), simply logging and returning back
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// for a later retry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">getErr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Failed to get a response: %s&#34;</span>, <span style="color:#a6e22e">getErr</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">incidentsResponse</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">IncidentsResponse</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">jsonError</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">NewDecoder</span>(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">Body</span>).<span style="color:#a6e22e">Decode</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">incidentsResponse</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">jsonError</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">jsonError</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> len(<span style="color:#a6e22e">incidentsResponse</span>.<span style="color:#a6e22e">Incidents</span>) &gt; <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We will then manage the GPIO pin state in a simple loop which will check to see if there are any open incidents. If so, it will set the pin to <em>High</em>, which will trigger the light switch. Otherwise it will set it to low. We will also include a handler for setting the pin to low when we terminate the application (ex. via a SIGTERM). Example of managing the state:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>		<span style="color:#75715e">// If there are any open New Relic incidents, set the pin to high
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">hasOpenIncidents</span>(<span style="color:#a6e22e">apiKey</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;Incidents detected, setting alarm.&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">pin</span>.<span style="color:#a6e22e">High</span>()
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;No incidents detected.&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">pin</span>.<span style="color:#a6e22e">Low</span>()
</span></span><span style="display:flex;"><span>		}
</span></span></code></pre></div><p>When you put it all together, the full picture of code looks like this (<code>alarm.go</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;encoding/json&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/spf13/viper&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/stianeikeland/go-rpio&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os/signal&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;syscall&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// New Relic Incident API type (just using including two of the fields as an example)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Incident</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Id</span>       <span style="color:#66d9ef">int</span>   <span style="color:#e6db74">`json:&#34;id&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">OpenedAt</span> <span style="color:#66d9ef">int64</span> <span style="color:#e6db74">`json:&#34;opened_at&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// New Relic Incident API response type, which we will assess on having any items in the array for the alarm.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IncidentsResponse</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Incidents</span> []<span style="color:#a6e22e">Incident</span> <span style="color:#e6db74">`json:&#34;incidents&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Documented here: https://rpm.newrelic.com/api/explore/alerts_incidents/list
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">hasOpenIncidents</span>(<span style="color:#a6e22e">apiKey</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">url</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;https://api.newrelic.com/v2/alerts_incidents.json?only_open=true&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">spaceClient</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Client</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Timeout</span>: <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">15</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewRequest</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">MethodGet</span>, <span style="color:#a6e22e">url</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;X-Api-Key&#34;</span>, <span style="color:#a6e22e">apiKey</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">res</span>, <span style="color:#a6e22e">getErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">spaceClient</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">req</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If there is a failure to calling New Relic (ex. timeout), simply logging and returning back
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// for a later retry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">getErr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Failed to get a response: %s&#34;</span>, <span style="color:#a6e22e">getErr</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">incidentsResponse</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">IncidentsResponse</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">jsonError</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">NewDecoder</span>(<span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">Body</span>).<span style="color:#a6e22e">Decode</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">incidentsResponse</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">jsonError</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">jsonError</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> len(<span style="color:#a6e22e">incidentsResponse</span>.<span style="color:#a6e22e">Incidents</span>) &gt; <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Simple handler to set the pin to a LOW signal when terminating the application
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">closeHandler</span>(<span style="color:#a6e22e">pin</span> <span style="color:#a6e22e">rpio</span>.<span style="color:#a6e22e">Pin</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Signal</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">signal</span>.<span style="color:#a6e22e">Notify</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Interrupt</span>, <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGTERM</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">c</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;SIGTERM detected, setting pin off&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">pin</span>.<span style="color:#a6e22e">Low</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Load configuration
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">viper</span>.<span style="color:#a6e22e">SetConfigName</span>(<span style="color:#e6db74">&#34;config&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">viper</span>.<span style="color:#a6e22e">AddConfigPath</span>(<span style="color:#e6db74">&#34;.&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">configErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">viper</span>.<span style="color:#a6e22e">ReadInConfig</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">configErr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panicf</span>(<span style="color:#e6db74">&#34;Fatal error config file: %s \n&#34;</span>, <span style="color:#a6e22e">configErr</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">apiKey</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">viper</span>.<span style="color:#a6e22e">GetString</span>(<span style="color:#e6db74">&#34;new_relic.api_key&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Setup GPIO pin
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;Opening GPIO&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rpio</span>.<span style="color:#a6e22e">Open</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panic</span>(<span style="color:#e6db74">&#34;Unable to open GPIO&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rpio</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Mapping to BCM2835 pin 18, which is the physical 12 pin. For more information about pin mapping, you can see
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// how these are being mapped: https://github.com/stianeikeland/go-rpio/blob/v4.4.0/rpio.go#L35-L59
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pin</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rpio</span>.<span style="color:#a6e22e">Pin</span>(<span style="color:#ae81ff">18</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pin</span>.<span style="color:#a6e22e">Output</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">closeHandler</span>(<span style="color:#a6e22e">pin</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// If it is after-hours, don&#39;t worry about triggering the alarm (trigger during: Mon - Fri, 9 - 5)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Weekday</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Weekday</span>() <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">5</span>) <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Hour</span>() &lt; <span style="color:#ae81ff">9</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Hour</span>() &gt; <span style="color:#ae81ff">17</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">pin</span>.<span style="color:#a6e22e">Low</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;After hours, sleeping for 5 minutes before continuing...&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Minute</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// If there are any open New Relic incidents, set the pin to high
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">hasOpenIncidents</span>(<span style="color:#a6e22e">apiKey</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;Incidents detected, setting alarm.&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">pin</span>.<span style="color:#a6e22e">High</span>()
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;No incidents detected.&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">pin</span>.<span style="color:#a6e22e">Low</span>()
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Minute</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="building">Building</h3>
<p>For my example, I have this in a <code>alarm.go</code> file within my <code>nr-pi-alarm</code> directory. I then issue the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>env GOOS<span style="color:#f92672">=</span>linux GOARCH<span style="color:#f92672">=</span>arm GOARM<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> go build
</span></span></code></pre></div><p>This will produce a <code>nr-pi-alarm</code> you can then transfer to your Raspberry Pi for execution. One example of doing this is with <code>scp</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Will transfer it to the alarm directory for the pi user on the Raspberry Pi</span>
</span></span><span style="display:flex;"><span>scp nr-pi-alarm pi@INSERT_YOUR_RASPBERRY_PI_IP_ADDRESS:alarm
</span></span></code></pre></div><h3 id="wiring-it-up">Wiring it up</h3>
<p>For this example, we are using the physical pins #12 and #14 (GPIO18 and GND). We will use our jumper wires to then hook this to the AC switch:</p>
<p><div align="center">
    <figure class="figure">
        <a href="pi-alarm-gpio.jpg" class="d-block" data-toggle="lightbox" data-gallery="post-gallery">
            <img src="pi-alarm-gpio.jpg"class="figure-img img-fluid"
            /> 
        </a>
    </figure>
</div>
<div align="center">
    <figure class="figure">
        <a href="pi-alarm-switch.jpg" class="d-block" data-toggle="lightbox" data-gallery="post-gallery">
            <img src="pi-alarm-switch.jpg"class="figure-img img-fluid"
            /> 
        </a>
    </figure>
</div></p>
<p>You will then hook your alarm light to the AC switch (PowerSwitch Tail). If the alarm light has its own on/off switch, turn it to on, as we don&rsquo;t want this manual switch to block what our Raspberry Pi is going to control based on the flow of power.</p>
<div align="center">
    <figure class="figure">
        <a href="pi-alarm-setup.jpg" class="d-block" data-toggle="lightbox" data-gallery="post-gallery">
            <img src="pi-alarm-setup.jpg"class="figure-img img-fluid"
            /> 
        </a>
    </figure>
</div>
<h3 id="run-it">Run it</h3>
<p>After you have transferred the build to your pi, you can then configure the alarm to use your New Relic account. This is achieved by creating a <code>config.yml</code> file in your <code>alarm</code> directory which currently hosts the <code>nr-pi-alarm</code> program (set to <code>600</code> for file permissions):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#f92672">new_relic</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">api_key</span>: <span style="color:#ae81ff">INSERT_NEW_RELIC_API_KEY_HERE</span>
</span></span></code></pre></div><p>After you have configured it, simply invoke this to run the alarm:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./nr-pi-alarm
</span></span><span style="display:flex;"><span>2019/03/14 10:04:12 Opening GPIO
</span></span><span style="display:flex;"><span>2019/03/14 10:04:26 Incidents detected, setting alarm.
</span></span></code></pre></div><div align="center">
    <figure class="figure">
        <a href="alarm.gif" class="d-block" data-toggle="lightbox" data-gallery="post-gallery">
            <img src="alarm.gif"class="figure-img img-fluid"
            /> 
        </a>
    </figure>
</div>
<h2 id="happy-pi-day">Happy Pi Day</h2>
<p>We hope you are having a great Pi Day and maybe this example will give you other ideas of what you can build to bring your systems alive. üòÄ</p>

                        </div><div class="tags my-3"><a class="badge badge-pill badge-light border mr-2" href="/tags/pi">
                                    <i class="fas fa-tag mr-2"></i>pi
                                </a><a class="badge badge-pill badge-light border mr-2" href="/tags/raspberry_pi">
                                    <i class="fas fa-tag mr-2"></i>raspberry_pi
                                </a></div><ul class="share nav my-3 justify-content-end">
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://twitter.com/intent/tweet?url=https%3a%2f%2fengineering.cerner.com%2fblog%2fpi-day-2019-build-your-own-alarm-system%2f&text=Pi%20Day%202019%3a%20Build%20your%20own%20alarm%20system">
              <i class="fa-fw fab fa-twitter"></i>
          </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fengineering.cerner.com%2fblog%2fpi-day-2019-build-your-own-alarm-system%2f&title=Pi%20Day%202019%3a%20Build%20your%20own%20alarm%20system">
                <i class="fa-fw fab fa-linkedin-in"></i>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fengineering.cerner.com%2fblog%2fpi-day-2019-build-your-own-alarm-system%2f&t=Pi%20Day%202019%3a%20Build%20your%20own%20alarm%20system">
                <i class="fa-fw fab fa-facebook-f"></i>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://reddit.com/submit?url=https%3a%2f%2fengineering.cerner.com%2fblog%2fpi-day-2019-build-your-own-alarm-system%2f&title=Pi%20Day%202019%3a%20Build%20your%20own%20alarm%20system">
                <i class="fa-fw fab fa-reddit-alien"></i>
            </a>
        </li>
    </nav>
                    </div>
                </div>

                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        
                    </div>
                </div></article>
        </div>
    </div>

    
</main>


    <footer class="footer text-center bg-dark py-6">
    <div class="container">
        <div class="row">
            <div class="col">
                <ul class="list-inline">
                    <li class="list-inline-item"><a href="https://engineering.cerner.com/index.xml" rel="alternate" type="application/rss+xml" class="icons d-block">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a></li><li class="list-inline-item">
                            <a href="https://github.com/cerner" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://www.instagram.com/cernercorporation/" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-instagram fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://www.linkedin.com/company/cerner-corporation" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fengineering.cerner.com%2F&amp;screen_name=CernerEng" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://www.youtube.com/user/cernereng?sub_confirmation=1" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-youtube fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                </ul>

                <p class="text-light">
                    
                        Copyright &copy; 2022
                    
                </p>

                <p class="text-light">
                Made with ‚ù§Ô∏è by Cerner engineers.
                </p>
            </div>
        </div>
    </div>
</footer>

    
    
        
            <script src="/dist/main.0f92af9103b4f0550a4b.min.js"></script>
        
    






    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-37701128-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
</body>
</html>
