<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>
  
     Structure Matters: How Cerner Handled Too Much Health Data in HBase | 
    Engineering Health
  
</title><meta name="description" content="a blog by engineers, for engineers"><meta name="author" content="Michelle Brush, Vinay Koduri">

<link rel="icon" href="/favicon.png">


    
        
            <link rel="stylesheet" href="/dist/main.2b1315bd4c5d4f5eb804.min.css">
        
    




<link rel="canonical" href="https://engineering.cerner.com/blog/structure-matters-how-cerner-handled-too-much-health-data-in-hbase/"><script src="/js/jquery-3.5.1.min.js"></script><meta property="og:title" content="Structure Matters: How Cerner Handled Too Much Health Data in HBase" />
<meta property="og:description" content="Background In order to manage the health of populations, Cerner builds data-driven solutions built on top of its HealtheIntent℠ platform. The platform transforms and standardizes data across disparate health systems. The data is then used in algorithms that aid healthcare providers and hospitals in managing and monitoring health both at a person and population level.
The Reference Record is one of the core components of the HealtheIntent platform. It represents the data known about a person&rsquo;s health from a particular source of healthcare information." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://engineering.cerner.com/blog/structure-matters-how-cerner-handled-too-much-health-data-in-hbase/" /><meta property="og:image" content="https://engineering.cerner.com/images/alan-grace.png"/><meta property="article:section" content="post" />
<meta property="article:published_time" content="2017-08-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2017-08-28T00:00:00+00:00" /><meta property="og:site_name" content="Cerner Engineering" />

<meta itemprop="name" content="Structure Matters: How Cerner Handled Too Much Health Data in HBase">
<meta itemprop="description" content="Background In order to manage the health of populations, Cerner builds data-driven solutions built on top of its HealtheIntent℠ platform. The platform transforms and standardizes data across disparate health systems. The data is then used in algorithms that aid healthcare providers and hospitals in managing and monitoring health both at a person and population level.
The Reference Record is one of the core components of the HealtheIntent platform. It represents the data known about a person&rsquo;s health from a particular source of healthcare information."><meta itemprop="datePublished" content="2017-08-28T00:00:00+00:00" />
<meta itemprop="dateModified" content="2017-08-28T00:00:00+00:00" />
<meta itemprop="wordCount" content="1301"><meta itemprop="image" content="https://engineering.cerner.com/images/alan-grace.png"/>
<meta itemprop="keywords" content="engineering,hbase," /><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://engineering.cerner.com/images/alan-grace.png"/>

<meta name="twitter:title" content="Structure Matters: How Cerner Handled Too Much Health Data in HBase"/>
<meta name="twitter:description" content="Background In order to manage the health of populations, Cerner builds data-driven solutions built on top of its HealtheIntent℠ platform. The platform transforms and standardizes data across disparate health systems. The data is then used in algorithms that aid healthcare providers and hospitals in managing and monitoring health both at a person and population level.
The Reference Record is one of the core components of the HealtheIntent platform. It represents the data known about a person&rsquo;s health from a particular source of healthcare information."/>

</head>
<body>
    
<nav class="navbar navbar-expand-md navbar-light bg-light fixed-top shadow-sm" id="navbar-main-menu">
    <div class="container">
        <a class="navbar-brand" href="/"><img src="/logo.png" style='width: 100px;' /></a>
        <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#main-menu" aria-controls="main-menu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div id="main-menu" class="collapse navbar-collapse" >
            <ul class="nav navbar-nav ml-auto">
                
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/culture/">Culture</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/open-source/">Open Source</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/tech-talks/">Tech Talks</a></li>
                
                    <li class="nav-item"><a class="nav-link" href="/careers/">Careers</a></li>
                
            
            </ul>
            
            <div class="form-inline my-2 my-lg-0 searchbox">
    <input id="search-by" type="search" class="form-control mr-sm-2" placeholder="Search" aria-label="Search">
</div>

<script type="text/javascript" src="/js/lunr.min.js"></script>
<script type="text/javascript" src="/js/auto-complete.min.js"></script>
<script type="text/javascript">
    var baseurl =  "https:\/\/engineering.cerner.com";
</script>
<script type="text/javascript" src="/js/search.js"></script>
        </div>
    </div>
</nav>


    
<main class="content-page container pt-7 pb-5">
    
    <div class="row">
        <div class="col">
            <article class="article-content">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="meta text-muted mb-3">
                            <p class="created text-muted text-uppercase font-weight-bold mb-1">August 28, 2017</p>
                            <span class="mr-2"><i class="fas fa-book-open mr-2"></i>1301 words</span>
                            <span><i class="fas fa-clock mr-2"></i>7 mins read</span>
                        </div>

                        <h1>Structure Matters: How Cerner Handled Too Much Health Data in HBase</h1>

                        <ul class="authors list-inline">
        By: &nbsp;<li class="list-inline-item mr-3">
                    <div class="media author">
                            👤&nbsp;<div class="media-body">
                            <h5 class="name my-0 "><a href="/authors/michelle-brush/" class="small">Michelle Brush</a>
                            </h5>
                        </div>
                    </div>
                </li><li class="list-inline-item mr-3">
                    <div class="media author">
                            👤&nbsp;<div class="media-body">
                            <h5 class="name my-0 "><a href="/authors/vinay-koduri/" class="small">Vinay Koduri</a>
                            </h5>
                        </div>
                    </div>
                </li></ul>
                    </div>
                </div>

                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="content">
                            <h3 id="background">Background</h3>
<p>In order to manage the health of populations, Cerner builds data-driven solutions built on top of its <em>HealtheIntent</em>℠ platform. The platform transforms and standardizes data across disparate health systems. The data is then used in algorithms that aid healthcare providers and hospitals in managing and monitoring health both at a person and population level.</p>
<p>The Reference Record is one of the core components of the HealtheIntent platform. It represents the data known about a person&rsquo;s health from a particular source of healthcare information. Downstream components in the platform aggregate information across multiple reference records to understand the full picture of a person&rsquo;s health.</p>
<p>To create the record, the system performs both batch and stream processing. Some sources send the data to HealtheIntent once a day or once a month. That data is processed in batch, using Hadoop MapReduce jobs. For sources that send the data as streams of updates in near real time, we rely on a homegrown near real time framework that sits on top of Apache Storm. Both the pipelines persist their processed data in HBase tables.</p>
<p>For the data processed in batch, we write all the data about the person from a given source to the HBase table as one HBase row. We refer to this as a wide table. The HBase Rowkey is the source identifier followed by the person identifier: <code>/source:&lt;id&gt;/person:&lt;id&gt;</code>. Each row could have multiple columns, one per each healthcare entity like allergy, medication, procedure, etc. Another thing to note is this table is salted for better distribution of data across regions. That means a given person&rsquo;s data will be in a single region since it&rsquo;s all in one row, but the data for a given source will be distributed across the HBase cluster.</p>
<p>For streaming sources, we use a different table approach. We have a tall table, where each healthcare entity is written separately. The Rowkey in this approach would be built from the source identifier, person identifier, entity type, and then individual entity identifier. This allows the system to manage the information flowing from the stream more efficiently.</p>
<p>To make sure that the consumers of the record don&rsquo;t have to know whether the data is coming from a streaming or batch source system, we offer a Crunch-based extract API that is capable of reading from either table structure. The API provides a single, consistent representation of the data.</p>
<p>The purpose of this post is to discuss what happened when a single person in our system received a little too much healthcare over the course of her fake life.</p>
<h3 id="the-investigation">The Investigation</h3>
<p>We were bringing a new source of healthcare data onto the HealtheIntent platform using our batch processing pipeline. In the midst of this work, a small number of MapReduce jobs started failing. Our failure monitoring triggered and notified us that something wasn&rsquo;t right.</p>
<p>We turned to the logs to investigate the failures. We saw this (not very informative) message:</p>
<blockquote>
<p>Task attempt_xxxx failed to report status for 601 seconds. Killing!</p>
</blockquote>
<p>Our first assumption was that the issue was related to memory, but we profiled the job and found that the heap utilization looked fine.</p>
<p>Querying across all the logs, we were able to see two key pieces of information. One, a job was more likely to fail if it was reading from a particular source of data, and two, failures were correlated with alerts on slow response times in HBase. Drilling deeper into our logs, we were able to find that sure enough, we were timing out trying to read from a particular region in HBase.</p>
<p>The next obvious step was to look at region metrics. We found the region had grown in size to 115 GB on a cluster configured to have a max region size of 10 GB. More logs showed the table had stopped compacting and splits weren&rsquo;t working due to a 30 GB row in the table.</p>
<p>At this time, anything trying to read that row was failing, but some large writes were still succeeding. There would be attempts to bulk load new data to the region, but the loads would invariably fail due to the large row. When the job ran again, it would attempt to write the same data, over and over. Occasionally during these attempts, some of the data would get written to the region. This process piled more and more data onto the region, and the region wouldn&rsquo;t split.</p>
<p>As the region was growing, the situation got worse. As previously mentioned, we salt the row keys to distribute data across the cluster. Jobs interested in other source data were also reading from this region, so we started seeing failures in other jobs. Then in the midst of our investigation, we saw more HBase region servers start failing. Then HBase bulk loads in other MapReduce jobs were also failing. We knew we had to get rid of the row and split the region.</p>
<p>As some team members worked on a plan to deal with the row, others moved on to answering the question, &ldquo;How did this one row get so big that the bulk loads started failing?&rdquo;</p>
<p>With healthcare data, it&rsquo;s possible to imagine diseases that might lead someone to have so many encounters and activity within a single healthcare system that we could get to a gigabyte of health data about a person. However, we had never seen anything near this large before. It was a pretty significant outlier.</p>
<h3 id="getting-rid-of-the-alternative-fact">Getting Rid of the Alternative Fact</h3>
<p>We decided to delete the person&rsquo;s data. However, the person had grown so large, this proved difficult. (The naive approach to deleting a row in HBase failed spectacularly.) Splitting was also not possible.</p>
<p>We needed a better plan. First, all reads and writes to the region had to stopped. This meant suspending all jobs that any potential to read or write. Since several teams depended on our data for their processing, we started by notifying all our downstream consumers. Then we stopped all reads and writes to the affected region. We copied the affected Hfiles to a new table. This allowed compaction (and as a result, deletion) to succeed. Cleaning up this one bad record brought the region size down to 2 GB from 200 GB. As part of this process, the table was disabled and the compacted Hfiles from the fixed region were copied back to the old table before it was re-enabled.</p>
<h3 id="damage">Damage</h3>
<p>When we stopped all the jobs loading into that table, we had a stale data period for downstream processing. Reports that needed the data showed old information during the length of the incident investigation and mitigation. The good news is that our near real-time algorithms such as our Sepsis alerts and readmissions risk assessments were built on top of the stream processing system which was not impacted by this incident.</p>
<h3 id="prevention">Prevention</h3>
<p>In our postmortem for the incident, we reviewed what we could have done better before, during, and immediately following the situation. A quick win for us was to add HBase region size monitoring &amp; alerting. It is still reactive, but would help us react faster and minimize the duration of the event.</p>
<p>Ultimately, the root of the problem is that we have an approach that encourages a lot of data to accumulate in a single row. We had a design flaw. While this patient was outside the realm of anything we&rsquo;d seen before, it wasn&rsquo;t outside the realm of possibility. To quote an oldie, but goodie from Frederick Brooks, &ldquo;Our first response should be to reorganize the modules&rsquo; data structures.&rdquo;</p>
<p>This event made us realize our batch and streaming representations of the data need to converge. That is the path we&rsquo;re now taking which will introduce its own set of challenges, but we&rsquo;re confident this will land us in a more stable, scalable place.</p>

                        </div><div class="tags my-3"><a class="badge badge-pill badge-light border mr-2" href="/tags/engineering">
                                    <i class="fas fa-tag mr-2"></i>engineering
                                </a><a class="badge badge-pill badge-light border mr-2" href="/tags/hbase">
                                    <i class="fas fa-tag mr-2"></i>hbase
                                </a></div><ul class="share nav my-3 justify-content-end">
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://twitter.com/intent/tweet?url=https%3a%2f%2fengineering.cerner.com%2fblog%2fstructure-matters-how-cerner-handled-too-much-health-data-in-hbase%2f&text=Structure%20Matters%3a%20How%20Cerner%20Handled%20Too%20Much%20Health%20Data%20in%20HBase">
              <i class="fa-fw fab fa-twitter"></i>
          </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://www.linkedin.com/shareArticle?url=https%3a%2f%2fengineering.cerner.com%2fblog%2fstructure-matters-how-cerner-handled-too-much-health-data-in-hbase%2f&title=Structure%20Matters%3a%20How%20Cerner%20Handled%20Too%20Much%20Health%20Data%20in%20HBase">
                <i class="fa-fw fab fa-linkedin-in"></i>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fengineering.cerner.com%2fblog%2fstructure-matters-how-cerner-handled-too-much-health-data-in-hbase%2f&t=Structure%20Matters%3a%20How%20Cerner%20Handled%20Too%20Much%20Health%20Data%20in%20HBase">
                <i class="fa-fw fab fa-facebook-f"></i>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" target="_blank" href="https://reddit.com/submit?url=https%3a%2f%2fengineering.cerner.com%2fblog%2fstructure-matters-how-cerner-handled-too-much-health-data-in-hbase%2f&title=Structure%20Matters%3a%20How%20Cerner%20Handled%20Too%20Much%20Health%20Data%20in%20HBase">
                <i class="fa-fw fab fa-reddit-alien"></i>
            </a>
        </li>
    </nav>
                    </div>
                </div>

                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        
                    </div>
                </div></article>
        </div>
    </div>

    <div class="related-content row mt-5 row-cols-1 row-cols-lg-3"><div class="col mb-3">
                <div class="card h-100">
    
    <a href="/blog/managing-splunk-knowledge/" class="d-block"><div class="card-body">
            <h4 class="card-title">Managing Splunk&#39;s Knowledge</h4>
            <p class="card-text text-muted text-uppercase">July 14, 2017</p>
            <div class="card-text">
                When we first were given access to Splunk we were excited about all the functionality it could provide our team to help us monitor and debug our applications. We created alerts to email us if our applications are logging errors, dashboards to show health or metrics of our services, and field extractions as well as tags to make searching easier. As we created more and more of these Splunk knowledge objects we started to have issues.
            </div>
        </div>
    </a>
  </div>
            </div><div class="col mb-3">
                <div class="card h-100">
    
    <a href="/blog/you-may-not-be-a-polyglot-but-your-code-needs-to-be/" class="d-block"><img data-src="/blog/you-may-not-be-a-polyglot-but-your-code-needs-to-be/polyglot_hubf76e1b056b3433d4c42b794581e56fe_162952_700x350_fill_box_smart1_3.png" class="card-img-top mx-auto d-block" alt="You May Not Be a Polyglot, but Your Code Needs to Be"><div class="card-body">
            <h4 class="card-title">You May Not Be a Polyglot, but Your Code Needs to Be</h4>
            <p class="card-text text-muted text-uppercase">July 7, 2017</p>
            <div class="card-text">
                Last October, I had the privilege to speak at Grace Hopper, the world’s largest gathering of women technologists. It was impressive to see 15,000 fellow female technologists gather together to share their experiences and technical expertise. To look into the audience, and see a room full of other female engineers was a great experience!
My talk was titled, You May Not Be a Polyglot, but Your Code Needs to Be (previously presented at Midwest.
            </div>
        </div>
    </a>
  </div>
            </div><div class="col mb-3">
                <div class="card h-100">
    
    <a href="/blog/shipit-day-viii-spring-2017/" class="d-block"><img data-src="/blog/shipit-day-viii-spring-2017/pic0_hu359c9cc63e2e114e5155f0fc9f0febee_148585_700x350_fill_box_smart1_3.png" class="card-img-top mx-auto d-block" alt="ShipIt VIII Day: Spring 2017"><div class="card-body">
            <h4 class="card-title">ShipIt VIII Day: Spring 2017</h4>
            <p class="card-text text-muted text-uppercase">May 17, 2017</p>
            <div class="card-text">
                ShipIt Day VIII was held on April 20 and 21st. Seventeen teams made up of internal associates had just 24 hours to create something innovative, usable, and value-adding. This quarter’s ShipIt Day was held at our new Innovations Campus in the Link Conference Center. We were excited to get to utilize the space for this event. Another awesome addition to this quarter’s ShipIt Day was our new game rooms.
            </div>
        </div>
    </a>
  </div>
            </div></div>
</main>


    <footer class="footer text-center bg-dark py-6">
    <div class="container">
        <div class="row">
            <div class="col">
                <ul class="list-inline">
                    <li class="list-inline-item"><a href="https://engineering.cerner.com/index.xml" rel="alternate" type="application/rss+xml" class="icons d-block">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a></li><li class="list-inline-item">
                            <a href="https://github.com/cerner" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://www.instagram.com/cernercorporation/" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-instagram fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://www.linkedin.com/company/cerner-corporation" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fengineering.cerner.com%2F&amp;screen_name=CernerEng" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li><li class="list-inline-item">
                            <a href="https://www.youtube.com/user/cernereng?sub_confirmation=1" class="icons d-block">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-youtube fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                </ul>

                <p class="text-light">
                    
                        Copyright &copy; 2022
                    
                </p>

                <p class="text-light">
                Made with ❤️ by Cerner engineers.
                </p>
            </div>
        </div>
    </div>
</footer>

    
    
        
            <script src="/dist/main.0f92af9103b4f0550a4b.min.js"></script>
        
    






    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-37701128-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
</body>
</html>
